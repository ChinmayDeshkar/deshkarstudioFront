<div *ngIf="loadingInvoice" class="loading-overlay">
  <div class="spinner"></div>
  <p>Generating and Downloading invoice...</p>
</div>

<div class="container py-4" *ngIf="purchase">
  <div class="card shadow border-0 p-4 rounded-4">

    <!-- Header -->
<div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-3">
  <!-- Job Title -->
  <h3 class="fw-bold text-primary mb-0 d-flex align-items-center">
    <i class="bi bi-receipt-cutoff me-2 fs-4"></i>
    Job #{{ purchase.purchaseId }}
  </h3>

  <!-- Action Buttons -->
  <div class="d-flex flex-wrap gap-2 align-items-center">
    <!-- Download Invoice -->
    <button *ngIf="purchase.orderStatus=='DELIVERED' || purchase.orderStatus == 'READY'" 
            class="btn btn-success btn-sm rounded-pill"
            (click)="downloadInvoice()">
      <i class="bi bi-download me-1"></i> Download Invoice
    </button>

    <!-- Edit / Cancel -->
    <ng-container *ngIf="jobActive">
      <button *ngIf="!editMode" class="btn btn-primary btn-sm rounded-pill" (click)="enableEdit()">
        <i class="bi bi-pencil me-1"></i> Edit
      </button>

      <button *ngIf="editMode" class="btn btn-warning btn-sm rounded-pill" (click)="disableEdit()">
        <i class="bi bi-x-circle me-1"></i> Cancel
      </button>
    </ng-container>

    <!-- Back Button -->
    <button class="btn btn-outline-secondary btn-sm rounded-pill" (click)="goBack()">
      <i class="bi bi-arrow-left me-1"></i> Back
    </button>
  </div>
</div>

    <form (ngSubmit)="updatePurchase()">

      <!-- Customer Card -->
      <div class="card border-0 bg-light p-3 rounded-3 mb-4">
        <h5 class="fw-bold text-secondary mb-3">
          <i class="bi bi-person-circle me-2"></i> Customer Details
        </h5>

        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Name</label>
            <input type="text" [(ngModel)]="purchase.customer.customerName" name="customerName" class="form-control"
              [readonly]="!editMode">
          </div>

          <div class="col-md-4">
            <label class="form-label">Email</label>
            <input type="email" [(ngModel)]="purchase.customer.email" name="email" class="form-control"
              [readonly]="!editMode">
            <small class="text-danger" *ngIf="purchase.customer.email && !isValidEmail(purchase.customer.email)">
              Invalid email!
            </small>
          </div>

          <div class="col-md-4">
            <label class="form-label">Phone</label>
            <input type="text" [(ngModel)]="purchase.customer.phoneNumber" name="phoneNumber" class="form-control"
              [readonly]="!editMode">
            <small class="text-danger"
              *ngIf="purchase.customer.phoneNumber && !isValidPhone(purchase.customer.phoneNumber)">
              Phone must be 10 digits.
            </small>
          </div>

          <div class="col-12">
            <label class="form-label">Address</label>
            <textarea rows="2" class="form-control" [(ngModel)]="purchase.customer.address" name="address"
              [readonly]="!editMode"></textarea>
          </div>
        </div>
      </div>

      <!-- Items -->
      <div class="card border-0 p-3 mb-4">
        <h5 class="fw-bold border-bottom pb-2">
          <i class="bi bi-bag-check me-2"></i> Items
        </h5>

        <div *ngFor="let item of purchase.items; let i=index" class="border rounded p-3 mb-3 bg-light">
          <div class="row g-3 align-items-end">

            <!-- Product -->
            <div class="col-md-5 product-select-wrapper">
              <label class="form-label">Product</label>
              <ng-select [items]="products" bindLabel="productName" bindValue="productId" placeholder="Select Product"
                [(ngModel)]="item.product.productId" name="product{{i}}" [readonly]="!editMode"
                (change)="onProductSelect(item)" appendTo="body">
              </ng-select>

            </div>

            <!-- Price -->
            <div class="col-md-3">
              <label class="form-label">Price</label>
              <input type="number" class="form-control" [(ngModel)]="item.itemPrice"
                (ngModelChange)="recalculateTotalPrice()" name="price{{i}}" [readonly]="!editMode">
            </div>

            <!-- Quantity -->
            <div class="col-md-2">
              <label class="form-label">Qty</label>
              <input type="number" class="form-control" [(ngModel)]="item.quantity" name="qty{{i}}"
                (ngModelChange)="recalculateTotalPrice()" [readonly]="!editMode">
            </div>

            <!-- Delete -->
            <div class="col-md-2 text-end" *ngIf="editMode">
              <button type="button" class="btn btn-outline-danger mt-4" (click)="removeItem(i)">
                <i class="bi bi-trash"></i>
              </button>
            </div>

          </div>
        </div>

        <!-- Add Item -->
        <div class="fw-semibold text-primary d-flex align-items-center" style="cursor:pointer" (click)="addItem()"
          *ngIf="editMode">
          <i class="bi bi-plus-circle me-2"></i> Add Item
        </div>
      </div>

      <!-- Purchase Summary -->
      <div class="card border-0 bg-light p-3 rounded-3 mb-4">
        <h5 class="fw-bold text-secondary mb-3">
          <i class="bi bi-wallet2 me-2"></i> Purchase Summary
        </h5>

        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Total Price</label>
            <input type="number" class="form-control" [(ngModel)]="purchase.price" name="price" [readonly]="!editMode"
              (input)="calculateBalance()">
          </div>

          <div class="col-md-4">
            <label class="form-label">Amount Paid</label>
            <input type="number" class="form-control" [(ngModel)]="purchase.advancePaid" name="advancePaid"
              [readonly]="!editMode" (input)="calculateBalance()">
          </div>

          <div class="col-md-4">
            <label class="form-label">Balance</label>
            <input type="number" class="form-control" [(ngModel)]="purchase.balance" name="balance" readonly>
          </div>
        </div>

        <div class="row g-3 mt-3">
          <div class="col-md-4">
            <label class="form-label">Payment Method</label>
            <select class="form-select" [(ngModel)]="purchase.paymentMethod" name="paymentMethod"
              [disabled]="!editMode">
              <option>Cash</option>
              <option>Online</option>
              <option>Card</option>
              <option>UPI</option>
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label">Payment Status</label>
            <select class="form-select" [(ngModel)]="purchase.paymentStatus" name="paymentStatus"
              [disabled]="!editMode">
              <option value="PAID">PAID</option>
              <option value="PENDING">PENDING</option>
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label">Order Status</label>
            <select class="form-select" [(ngModel)]="purchase.orderStatus" name="orderStatus" [disabled]="!editMode">
              <option value="CREATED">CREATED</option>
              <option value="PROCESSING">PROCESSING</option>
              <option value="ON-HOLD">ON-HOLD</option>
              <option value="READY">READY</option>
              <option value="DELIVERED">DELIVERED</option>
              <option value="CANCELLED">CANCELLED</option>
            </select>
          </div>

          <!-- Validation Messages -->
          <div class="text-danger small mt-2" *ngIf="purchase.orderStatus=='DELIVERED' && purchase.balance>0">
            Cannot mark DELIVERED when balance is pending.
          </div>

          <div class="text-danger small mt-1" *ngIf="purchase.paymentStatus=='PAID' && purchase.balance>0">
            Paid status invalid: Balance pending.
          </div>

          <div class="text-danger small mt-1" *ngIf="purchase.paymentStatus=='PENDING' && purchase.balance==0">
            Pending status invalid: No balance remaining.
          </div>
        </div>
      </div>

      <!-- Remarks -->
      <div class="mb-4">
        <label class="form-label">Remarks</label>
        <textarea rows="3" class="form-control" [(ngModel)]="purchase.remarks" name="remarks"
          [readonly]="!editMode"></textarea>
      </div>

      <!-- Save Button -->
      <div class="text-end" *ngIf="editMode">
        <button type="submit" class="btn btn-success px-4 rounded-pill">
          <i class="bi bi-save2 me-1"></i> Save Changes
        </button>
      </div>

    </form>

    <!-- Notes -->
    <div class="card mt-4 p-3 shadow-sm rounded">
      <h5 class="fw-bold text-secondary mb-3">
        <i class="bi bi-journal-text me-2"></i> Update Notes
      </h5>

      <div *ngIf="notes.length; else noNotes">
        <div class="table-responsive">
          <table class="table table-bordered">
            <thead class="table-dark">
              <tr>
                <th class="text-center">Time</th>
                <th class="text-center">Updated By</th>
                <th>Note</th>
              </tr>
            </thead>

            <tbody>
              <tr *ngFor="let n of notes">
                <td class="text-center">{{ n.dte_updated }}</td>
                <td class="text-center">{{ n.updatedBy }}</td>
                <td><i class="bi bi-chat-left-text text-primary me-1"></i>{{ n.note }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <ng-template #noNotes>
        <div class="text-center text-muted py-3">
          <i class="bi bi-journal-x fs-3 d-block mb-2"></i>
          No notes available.
        </div>
      </ng-template>
    </div>

  </div>
</div>