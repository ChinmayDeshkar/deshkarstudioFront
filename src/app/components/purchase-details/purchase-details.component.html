<div class="container py-5" *ngIf="purchase">
  <div class="card shadow-lg border-0 p-4 rounded-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h3 class="fw-bold text-primary m-0">
        <i class="bi bi-pencil-square me-2"></i> Edit Purchase #{{ purchase.purchaseId }}
      </h3>
      <button class="btn btn-outline-secondary btn-sm rounded-pill" (click)="goBack()">
        <i class="bi bi-arrow-left"></i> Back
      </button>
    </div>

    <form (ngSubmit)="updatePurchase()">

      <!-- Customer Info -->
      <div class="card mb-4 border-0 bg-light p-3 rounded-3">
        <h5 class="fw-semibold text-secondary mb-3">
          <i class="bi bi-person-circle me-2"></i> Customer Details
        </h5>
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Name</label>
            <input type="text" class="form-control" [(ngModel)]="purchase.customer.customerName" name="customerName"
              readonly />
          </div>
          <div class="col-md-4">
            <label class="form-label">Email</label>
            <input type="email" class="form-control" [(ngModel)]="purchase.customer.email" name="email" readonly />
          </div>
          <div class="col-md-4">
            <label class="form-label">Phone</label>
            <input type="text" class="form-control" [(ngModel)]="purchase.customer.phoneNumber" name="phoneNumber"
              readonly />
          </div>
          <div class="col-12">
            <label class="form-label">Address</label>
            <textarea class="form-control" [(ngModel)]="purchase.customer.address" name="address" rows="2"
              readonly></textarea>
          </div>
        </div>
      </div>

      <!-- Items Table -->
      <div class="card mb-4 border-0 bg-light p-3 rounded-3">
        <h5 class="fw-semibold text-secondary mb-3">
          <i class="bi bi-box-seam me-2"></i> Items Purchased
        </h5>

        <div *ngIf="purchase.items && purchase.items.length > 0; else noItems">
          <div class="table-responsive">
            <table class="table table-bordered align-middle">
              <thead class="table-primary">
                <tr>
                  <th>Product</th>
                  <th width="80">Qty</th>
                  <th width="150">Item Price (₹)</th>
                  <th width="150">Total (₹)</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of purchase.items">
                  <td>{{ item.product?.productName || 'N/A' }}</td>
                  <td>{{ item.quantity }}</td>
                  <td>{{ item.itemPrice | number:'1.2-2' }}</td>
                  <td>{{ item.total | number:'1.2-2' }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <ng-template #noItems>
          <div class="text-muted text-center py-3">
            <i class="bi bi-inboxes fs-3 d-block mb-2"></i>
            No items found for this purchase.
          </div>
        </ng-template>
      </div>

      <!-- Purchase Info -->
      <div class="card mb-4 border-0 bg-light p-3 rounded-3">
        <h5 class="fw-semibold text-secondary mb-3">
          <i class="bi bi-cash-stack me-2"></i> Purchase Details
        </h5>

        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Price (₹)</label>
            <input type="number" class="form-control" [(ngModel)]="purchase.price" name="price"
              (input)="calculateBalance()" required readonly />
          </div>
          <div class="col-md-4">
            <label class="form-label">Amount Paid (₹)</label>
            <input type="number" class="form-control" [(ngModel)]="purchase.advancePaid" name="advancePaid"
              (input)="calculateBalance(); validatePaymentStatus()" />
          </div>

          <div class="col-md-4">
            <label class="form-label">Balance (₹)</label>
            <input type="number" class="form-control" [(ngModel)]="purchase.balance" name="balance"
              (input)="calculateBalance(); validatePaymentStatus()" readonly />
          </div>
        </div>

        <div *ngIf="amountError" class="text-danger fw-semibold mt-1">
          {{ amountError }}
        </div>

        <div class="row g-3 mt-3">
          <div class="col-md-4">
            <label class="form-label">Payment Method</label>
            <select class="form-select" [(ngModel)]="purchase.paymentMethod" name="paymentMethod">
              <option value="Cash">Cash</option>
              <option value="Online">Online</option>
              <option value="Card">Card</option>
              <option value="UPI">UPI</option>
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label">Payment Status</label>
            <select class="form-select" [(ngModel)]="purchase.paymentStatus" name="paymentStatus"
              (change)="validatePaymentStatus()">

              <option value="PAID">PAID</option>
              <option value="PENDING">PENDING</option>
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label">Order Status</label>
            <select class="form-select" [(ngModel)]="purchase.orderStatus" name="orderStatus">
              <option value="CREATED">CREATED</option>
              <option value="PROCESSING">PROCESSING</option>
              <option value="ON-HOLD">ON-HOLD</option>
              <option value="READY">READY</option>
              <option value="DELIVERED">DELIVERED</option>
              <option value="CANCELLED">CANCELLED</option>
            </select>
          </div>
        </div>
        <div *ngIf="paymentError" class="text-danger fw-semibold mt-1">
          {{ paymentError }}
        </div>

      </div>

      <!-- Remarks -->
      <div class="mb-4">
        <label class="form-label">Remarks</label>
        <textarea class="form-control" rows="3" [(ngModel)]="purchase.remarks" name="remarks"
          placeholder="Enter remarks or notes..."></textarea>
      </div>

      <!-- Metadata -->
      <div class="row g-3 text-muted small mb-4">
        <div class="col-md-4">
          <b>Created:</b> {{ purchase.createdDate }}
        </div>
        <div class="col-md-4">
          <b>Last Updated:</b> {{ purchase.updatedDate }}
        </div>
        <div class="col-md-4">
          <b>Updated By:</b> {{ purchase.updatedBy }}
        </div>
      </div>

      <!-- Buttons -->
      <div class="text-end">
        <button type="submit" class="btn btn-success px-4 rounded-pill me-2" [disabled]="amountError || paymentError">
          <i class="bi bi-save2 me-2"></i> Update Purchase
        </button>
      </div>
    </form>
  </div>
</div>